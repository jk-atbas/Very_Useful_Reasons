name: PR pipeline

on:
  pull_request: 
    types: 
      - opened
      - reopened
      - synchronize

jobs:
  build:
    runs-on: ubuntu-latest
    container: 
      image: mcr.microsoft.com/dotnet/sdk:9.0
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
      - name: Build project
        run: dotnet build ./src/lib/*.csproj -c Release

  test:
    runs-on: ubuntu-latest
    container: 
      image: mcr.microsoft.com/dotnet/sdk:9.0
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
      - name: Run tests
        run: dotnet test ./*.slnx

  pre-release:
    runs-on: ubuntu-latest
    container: 
      image: mcr.microsoft.com/dotnet/sdk:9.0
      env: 
        Nuget_Test_Pat: ${{ secrets.GITHUB_TOKEN }}
        
    permissions: 
      packages: write
    needs:
      - build
      - test
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
      - name: Setup Nerdbank.GitVersioning
        uses: dotnet/nbgv@v0.4.2
        id: nbgv
      - name: Test output for secret
        run: echo $Nuget_Test_Pat
      - name: Calculate Pre-release Suffix
        id: suffix
        run: |
          PR_NUMBER=$(echo $GITHUB_REF_NAME | cut -d'/' -f1)
          echo "PR-Number: $PR_NUMBER"
          echo "PR Run-Number: $GITHUB_RUN_NUMBER"
          echo "suffix=rc-pr-${PR_NUMBER}-${GITHUB_RUN_NUMBER}" >> $GITHUB_OUTPUT
      - name: Output Pre-release version info
        id: version
        run: | 
          echo "Suffix=${{ steps.suffix.outputs.suffix }}"
          FULLVERSION="${{ steps.nbgv.outputs.SimpleVersion }}-${{ steps.suffix.outputs.suffix }}"
          echo "Fullversion= ${FULLVERSION}"
          echo "full-version=${FULLVERSION}" >> $GITHUB_OUTPUT
      # - name: Pack and Bundle package
      #   run: |
      #     dotnet pack ./src/lib/*.csproj -c Release /p:PublicRelease=true /p:ForcePackageVersion=${{ steps.version.outputs.full-version }}
      # - name: Add nuget package source
      #   run: |
      #     dotnet nuget add source --username $GITHUB_REPOSITORY_OWNER --password "${{ secrets.GITHUB_TOKEN }}" --store-password-in-clear-text --name github "https://nuget.pkg.github.com/jk-atbas/index.json"
      # - name: Push to nuget registry
      #   if: ${{ github.event.pull_request.head.repo.full_name == github.repository }}
      #   run: dotnet nuget push ./src/lib/bin/Release/*.nupkg --api-key "${{ secrets.GITHUB_TOKEN }}" --source github --skip-duplicate
