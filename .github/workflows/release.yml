name: Release pipeline on main
on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      create-release:
        description: Whether to create and upload a nuget package
        required: false
        default: true
        type: boolean

# env:
#   DOTNET_INSTALL_DIR: "~/dotnet"

jobs:
  build:
    runs-on: ubuntu-latest
    container: 
      image: mcr.microsoft.com/dotnet/sdk:9.0
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
      # not needed when container is used
      # - name: Setup .NET
      #   uses: actions/setup-dotnet@v5
      #   with:
      #     dotnet-version: "9.x"
      #     cache-dependency-path: ./src/lib/packages.lock.json
      #     cache: true
      - name: Build solution
        run: dotnet build ./*.slnx -c Release

  test:
    runs-on: ubuntu-latest
    container: 
      image: mcr.microsoft.com/dotnet/sdk:9.0
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
      - name: Run tests
        run: dotnet test ./*.slnx

  release: 
    runs-on: ubuntu-latest
    container: 
      image: mcr.microsoft.com/dotnet/sdk:9.0
    permissions: 
      packages: write
      contents: write
    needs: [build, test]
    if: github.event_name == 'push' || inputs.create-release == true
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
            fetch-depth: 0
      - name: Use Nerdbank.GitVersioning
        uses: dotnet/nbgv@v0.4.2
        id: version
      - name: Build and Pack
        run: dotnet pack ./src/lib/*.csproj -c Release
      - name: Create Package name
        id: package-info
        run: | 
          REPO_NAME=${GITHUB_REPOSITORY##*/}
          CURRENT_DATE=$(date +'%d-%m-%Y_%H-%M-%S')
          echo "package-name=${REPO_NAME}_${CURRENT_DATE}" >> $GITHUB_OUTPUT
      - name: Give information
        run: |
          echo "Package name: ${{steps.package-info.outputs.package-name}}"
          echo "Package version: ${{steps.version.outputs.SemVer2}}"
      - name: Add nuget package source
        run: |
          dotnet nuget add source --username jk-atbas --password "${{ secrets.GITHUB_TOKEN }}" --store-password-in-clear-text --name github "https://nuget.pkg.github.com/jk-atbas/index.json"
      - name: Publish package to nuget registry
        run: dotnet nuget push ./src/lib/bin/Release/*.nupkg --api-key "${{ secrets.GITHUB_TOKEN }}" --source github
      - name: Create Release
        uses: ncipollo/release-action@v1.20.0
        with:
          skipIfReleaseExists: true
          name: ${{ steps.package-info.outputs.package-name }}_${{ steps.version.outputs.SemVer2 }}
          generateReleaseNotes: true
          replacesArtifacts: false

          